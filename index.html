<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Reserva de Tenis</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&display=swap" rel="stylesheet">
  <style>
    /* ==================== RESET Y BASE ==================== */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --primary: #2ecc71;
      --primary-dark: #27ae60;
      --primary-light: #a8e6cf;
      --secondary: #3498db;
      --secondary-dark: #2980b9;
      --danger: #e74c3c;
      --warning: #f39c12;
      --dark: #2c3e50;
      --dark-light: #34495e;
      --gray: #7f8c8d;
      --gray-light: #bdc3c7;
      --gray-lighter: #ecf0f1;
      --white: #ffffff;
      --success-bg: #d5f4e6;
      --success-border: #27ae60;
      --shadow-sm: 0 2px 4px rgba(0,0,0,0.08);
      --shadow-md: 0 4px 12px rgba(0,0,0,0.12);
      --shadow-lg: 0 8px 24px rgba(0,0,0,0.15);
      --border-radius: 12px;
      --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    body {
      font-family: 'Roboto', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
      color: var(--dark);
      line-height: 1.6;
    }

    /* ==================== CONTAINER ==================== */
    body > div:not(#loading) {
      max-width: 900px;
      margin: 0 auto;
      background: var(--white);
      padding: clamp(20px, 5vw, 40px);
      border-radius: var(--border-radius);
      box-shadow: var(--shadow-lg);
      animation: fadeInUp 0.6s ease-out;
    }

    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* ==================== TYPOGRAPHY ==================== */
    h1, h2, h4 {
      text-align: center;
      color: var(--dark);
      font-weight: 700;
      margin-bottom: 1rem;
    }

    h1 {
      font-size: clamp(1.75rem, 4vw, 2.5rem);
      background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 0.5rem;
    }

    h2 {
      font-size: clamp(1.5rem, 3.5vw, 2rem);
      color: var(--dark);
      position: relative;
      padding-bottom: 15px;
    }

    h2::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 60px;
      height: 3px;
      background: linear-gradient(90deg, var(--primary), var(--secondary));
      border-radius: 2px;
    }

    h4 {
      font-size: 1.1rem;
      color: var(--dark-light);
      margin: 1rem 0 0.75rem;
    }

    p {
      margin: 0.75rem 0;
    }

    /* ==================== UTILITY CLASSES ==================== */
    .hidden {
      display: none !important;
    }

    /* ==================== FORMS ==================== */
    label {
      display: block;
      margin-top: 1.25rem;
      font-weight: 600;
      font-size: 0.95rem;
      color: var(--dark-light);
      margin-bottom: 0.5rem;
    }

    label:first-of-type {
      margin-top: 1.5rem;
    }

    input, select {
      width: 100%;
      padding: 12px 16px;
      margin-top: 0;
      border: 2px solid var(--gray-lighter);
      border-radius: 8px;
      font-size: 1rem;
      font-family: inherit;
      transition: var(--transition);
      background: var(--white);
    }

    input:focus, select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(46, 204, 113, 0.1);
    }

    input:hover, select:hover {
      border-color: var(--gray-light);
    }

    input::placeholder {
      color: var(--gray-light);
    }

    small {
      display: block;
      margin-top: 0.5rem;
      font-size: 0.85rem;
      color: var(--gray);
    }

    small[style*="color:#e74c3c"], small[style*="color: #e74c3c"] {
      color: var(--danger) !important;
      font-weight: 500;
    }

    /* ==================== BUTTONS ==================== */
    button {
      width: 100%;
      padding: 14px 24px;
      margin-top: 1.5rem;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      box-shadow: var(--shadow-sm);
      position: relative;
      overflow: hidden;
    }

    button:not(.secondary) {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      color: var(--white);
    }

    button:not(.secondary):hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }

    button:not(.secondary):active {
      transform: translateY(0);
    }

    button.secondary {
      background: linear-gradient(135deg, var(--gray) 0%, var(--dark-light) 100%);
      color: var(--white);
    }

    button.secondary:hover {
      background: linear-gradient(135deg, var(--dark-light) 0%, var(--dark) 100%);
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }

    /* Botón de cobrar en tabla admin */
    #admin-table button {
      background: linear-gradient(135deg, #e67e22 0%, #d35400 100%);
      width: 100%;
      padding: 6px 10px;
      font-size: 0.8rem;
      margin-top: 4px;
    }

    #admin-table button:hover {
      background: linear-gradient(135deg, #d35400 0%, #c0392b 100%);
    }

    /* ==================== PRICE DISPLAY ==================== */
    div[class="price-display"], #precio-total {
      background: linear-gradient(135deg, var(--success-bg) 0%, #e8f8f5 100%);
      padding: 20px;
      border-radius: 10px;
      margin-top: 1.5rem;
      text-align: center;
      font-size: 1.5rem;
      border: 2px solid var(--success-border);
      color: var(--primary-dark);
      font-weight: 700;
      box-shadow: var(--shadow-sm);
      animation: pulse 2s ease-in-out infinite;
    }

    @keyframes pulse {
      0%, 100% {
        box-shadow: var(--shadow-sm);
      }
      50% {
        box-shadow: 0 0 20px rgba(46, 204, 113, 0.3);
      }
    }

    /* ==================== TABLES ==================== */
    div[class="table-responsive"] {
      overflow-x: auto;
      margin-top: 1.5rem;
      border-radius: 8px;
      box-shadow: var(--shadow-sm);
    }

    table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      font-size: 0.9rem;
    }

    th, td {
      padding: 14px 12px;
      text-align: left;
      border-bottom: 1px solid var(--gray-lighter);
    }

    th {
      background: linear-gradient(135deg, var(--dark) 0%, var(--dark-light) 100%);
      color: var(--white);
      font-weight: 600;
      text-transform: uppercase;
      font-size: 0.8rem;
      letter-spacing: 0.5px;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    th:first-child {
      border-top-left-radius: 8px;
    }

    th:last-child {
      border-top-right-radius: 8px;
    }

    tbody tr {
      transition: var(--transition);
    }

    tbody tr:hover {
      background: var(--gray-lighter);
      transform: scale(1.01);
    }

    tbody tr:last-child td {
      border-bottom: none;
    }

    td[class*="status"] {
      font-weight: 600;
      text-transform: uppercase;
      font-size: 0.85rem;
    }

    .status-pagado, td[class="status-pagado"] {
      color: var(--primary) !important;
    }

    .status-pendiente, td[class="status-pendiente"] {
      color: var(--warning) !important;
    }

    /* ==================== LOADING OVERLAY ==================== */
    #loading {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(8px);
      z-index: 9999;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 1.5rem;
      color: var(--dark);
      font-weight: 600;
    }

    #loading::after {
      content: '';
      width: 50px;
      height: 50px;
      border: 5px solid var(--gray-lighter);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-left: 20px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* ==================== SPECIFIC SECTIONS ==================== */
    
    /* Login view */
    #view-login p[style*="text-align:center"] {
      color: var(--gray);
      margin-bottom: 2rem;
    }

    #view-login > div[style*="text-align:center"] {
      margin-top: 2rem;
      padding-top: 1.5rem;
      border-top: 2px solid var(--gray-lighter);
    }

    #view-login a {
      color: var(--gray);
      text-decoration: none;
      transition: var(--transition);
      font-size: 0.9rem;
    }

    #view-login a:hover {
      color: var(--primary);
      text-decoration: underline;
    }

    /* Booking view */
    #config-area > div[style*="display:flex"] {
      display: flex !important;
      gap: 15px !important;
      margin-bottom: 1rem;
    }

    #config-area > div[style*="display:flex"] > div {
      flex: 1 !important;
    }

    /* Jugadores container */
    #jugadores-container, div[id="jugadores-container"] {
      margin-top: 1.5rem !important;
      border: 2px solid var(--gray-lighter) !important;
      padding: 20px !important;
      border-radius: 10px !important;
      background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
    }

    #jugadores-container > div[style*="margin-bottom:5px"] {
      margin-bottom: 10px !important;
      padding: 12px !important;
      background: var(--primary-light) !important;
      border-radius: 8px !important;
      font-weight: 500;
    }

    #jugadores-container > div[style*="margin-bottom:10px"] {
      margin-bottom: 15px !important;
      background: var(--white) !important;
      padding: 15px !important;
      border-bottom: 2px solid var(--gray-lighter) !important;
      border-radius: 8px;
      transition: var(--transition);
    }

    #jugadores-container > div[style*="margin-bottom:10px"]:hover {
      box-shadow: var(--shadow-sm);
      transform: translateX(5px);
    }

    #jugadores-container > div[style*="margin-bottom:10px"]:last-child {
      border-bottom: none !important;
    }

    #jugadores-container div[style*="display:flex"] {
      display: flex !important;
      gap: 10px !important;
      align-items: flex-end;
    }

    #jugadores-container select[class="tipo-jugador"] {
      width: 40% !important;
    }

    #jugadores-container input[class="dato-jugador"] {
      width: 60% !important;
      margin-top: 0 !important;
    }

    /* Success view */
    #view-success h2[style*="color:green"] {
      color: var(--primary) !important;
      animation: bounceIn 0.6s ease-out;
    }

    @keyframes bounceIn {
      0% {
        opacity: 0;
        transform: scale(0.3);
      }
      50% {
        opacity: 1;
        transform: scale(1.05);
      }
      70% {
        transform: scale(0.9);
      }
      100% {
        transform: scale(1);
      }
    }

    #resumen-final, div[id="resumen-final"] {
      background: var(--success-bg) !important;
      padding: 20px !important;
      border-radius: 10px !important;
      border: 2px solid var(--success-border) !important;
      margin: 1.5rem 0;
    }

    #resumen-final p {
      margin: 0.75rem 0;
      font-size: 1rem;
    }

    #resumen-final strong {
      color: var(--primary-dark);
      font-weight: 600;
    }

    /* Admin table actions */
    #admin-table td > div[style*="display:flex"] {
      display: flex !important;
      flex-direction: column !important;
      gap: 5px !important;
    }

    #admin-table select {
      font-size: 0.85rem !important;
      padding: 6px 8px !important;
    }

    /* ==================== RESPONSIVE ==================== */
    @media (max-width: 768px) {
      body {
        padding: 10px;
      }

      h1 {
        font-size: 1.75rem;
      }

      h2 {
        font-size: 1.5rem;
      }

      #config-area > div[style*="display:flex"] {
        flex-direction: column !important;
        gap: 0 !important;
      }

      table {
        font-size: 0.8rem;
      }

      th, td {
        padding: 10px 8px;
      }

      button {
        padding: 12px 20px;
      }

      div[class="price-display"], #precio-total {
        font-size: 1.25rem;
        padding: 15px;
      }
    }

    @media (max-width: 480px) {
      body > div:not(#loading) {
        padding: 20px 15px;
      }

      input, select, button {
        font-size: 0.95rem;
      }

      #jugadores-container div[style*="display:flex"] {
        flex-direction: column !important;
      }

      #jugadores-container select[class="tipo-jugador"],
      #jugadores-container input[class="dato-jugador"] {
        width: 100% !important;
      }
    }

    /* ==================== PRINT STYLES ==================== */
    @media print {
      body {
        background: white;
      }

      button, #view-login, #view-admin {
        display: none;
      }
    }
  </style>
</head>
<body>

<div id="loading" class="hidden">Procesando...</div>

<div class="container">
  
  <div id="view-login">
    <h1>Bienvenido al Club de Tenis</h1>
    <p style="text-align:center;">Por favor, valide su identidad para reservar.</p>
    
    <label>Número de Socio</label>
    <input type="number" id="login-socio" placeholder="Ej: 1234">
    
<label>Fecha de Nacimiento (DD/MM/AAAA)</label>
<input type="text" id="login-fecha" placeholder="DD/MM/AAAA" maxlength="10" inputmode="numeric">
<small style="color:#666;">Formato automático: solo ingrese números.</small>
    
    <button onclick="validarUsuario()">Ingresar</button>
    <br><br>
    <div style="text-align:center; margin-top:20px; border-top:1px solid #eee; padding-top:10px;">
        <small><a href="#" onclick="showAdminLogin()" style="color:#999; text-decoration:none;">Acceso Administrador</a></small>
    </div>
  </div>

  <div id="view-booking" class="hidden">
    <h2 id="welcome-msg">Hola Socio</h2>
    
    <label>Fecha de Reserva (Martes a Domingo)</label>
    <input type="date" id="reserva-fecha" onchange="cargarConfiguracionDia()">
    
    <div id="config-area" class="hidden">
      <div style="display:flex; gap:10px;">
        <div style="flex:1;">
           <label>Hora Inicio (7 a 21hs)</label>
           <select id="reserva-hora" onchange="calcularPrecio()">
             </select>
        </div>
        <div style="flex:1;">
           <label>Duración</label>
           <select id="reserva-duracion" onchange="cargarCanchas(); calcularPrecio();">
             <option value="1">1 Hora</option>
             <option value="2">2 Horas</option>
           </select>
        </div>
      </div>

      <label>Tipo de Juego</label>
      <select id="reserva-tipo" onchange="generarCamposJugadores(); calcularPrecio();">
        <option value="single">Single (2 Personas)</option>
        <option value="doble">Dobles (4 Personas)</option>
      </select>
      
      <label>Seleccionar Cancha Disponible</label>
      <select id="reserva-cancha">
        <option value="">-- Seleccione fecha y hora primero --</option>
      </select>
      <small style="color:#e74c3c;" id="msg-disponibilidad"></small>

      <div id="jugadores-container" style="margin-top:15px; border:1px solid #ddd; padding:10px; border-radius:5px;">
        </div>

      <div class="price-display" id="precio-total">
        Total a Pagar: $0
      </div>
      
      <p style="text-align:center; font-size:0.85em; color:#666; margin-top:10px;">
        Medios de pago: Efectivo, Débito, Crédito o QR en casilla.
      </p>

      <button onclick="enviarReserva()">Confirmar Reserva</button>
    </div>
  </div>

  <div id="view-success" class="hidden">
    <h2 style="color:green;">¡Reserva Exitosa!</h2>
    <div id="resumen-final" style="background:#f0f9f0; padding:15px; border-radius:5px; border:1px solid green;"></div>
    <p style="text-align:center;">Por favor, acérquese a la casilla para abonar antes de ingresar.</p>
    <button onclick="location.reload()">Volver al Inicio</button>
  </div>

  <div id="view-admin" class="hidden">
    <h2>Panel de Administración</h2>
    <button class="secondary" onclick="location.reload()" style="margin-bottom:10px;">Salir</button>
    <div class="table-responsive">
      <table id="admin-table">
        <thead>
          <tr>
            <th>Fecha/Hora</th>
            <th>Cancha</th>
            <th>Titular</th>
            <th>Total</th>
            <th>Estado</th>
            <th>Acción</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

</div>

<script>
  // --- MÁSCARA DE FECHA AUTOMÁTICA ---
  document.addEventListener("DOMContentLoaded", function() {
    const inputFecha = document.getElementById('login-fecha');
    
    inputFecha.addEventListener('input', function(e) {
      // 1. Eliminar cualquier caracter que no sea número
      let valor = this.value.replace(/\D/g, '');
      
      // 2. Limitar a 8 dígitos (DDMMAAAA)
      if (valor.length > 8) valor = valor.substring(0, 8);
      
      // 3. Formatear agregando las barras
      let formateado = "";
      if (valor.length > 4) {
        formateado = valor.substring(0, 2) + '/' + valor.substring(2, 4) + '/' + valor.substring(4);
      } else if (valor.length > 2) {
        formateado = valor.substring(0, 2) + '/' + valor.substring(2);
      } else {
        formateado = valor;
      }
      
      // 4. Asignar el valor formateado
      this.value = formateado;
    });
  });
  // ==========================================================================
  // CONFIGURACIÓN DE CONEXIÓN
  // ==========================================================================
  
  // PEGA TU URL DE APPS SCRIPT AQUÍ ABAJO (Debe terminar en /exec)
  const API_URL = "https://script.google.com/macros/s/AKfycbxaAz1Z1PKwIyiyDV_WCT1qhHC_ALdsgpqH0U0Xf1oeWFHYHISjK5unJtyCtSYISMu7/exec"; 

  // ==========================================================================

  // --- VARIABLES GLOBALES ---
  let usuarioActual = "";
  const precioBaseSocio = 1000;
  const precioBaseNoSocio = 2000;
  const precioPicoSocio = 1500;
  const precioPicoNoSocio = 2500;

  // --- FUNCIÓN GENÉRICA PARA CONECTAR CON APPS SCRIPT ---
  async function llamarAPI(accion, datos = {}) {
    if (API_URL.includes("PEGAR_AQUI")) {
      alert("Error de configuración: No has puesto la URL del Script en el código HTML.");
      return null;
    }

    const loader = document.getElementById('loading');
    loader.classList.remove('hidden');
    
    // Convertimos datos a JSON stringificado compatible con Apps Script
    // action va dentro del payload para que doPost lo lea
    const bodyContent = JSON.stringify({ action: accion, ...datos });

    try {
      const response = await fetch(API_URL, {
        method: "POST",
        body: bodyContent
        // Nota: Apps Script no requiere headers especiales para text/plain, 
        // y CORS se maneja automáticamente si el script está como "Any user".
      });
      
      const resultado = await response.json();
      loader.classList.add('hidden');
      return resultado;

    } catch (error) {
      loader.classList.add('hidden');
      console.error("Error API:", error);
      alert("Error de conexión con el servidor. Verifique su internet o intente nuevamente.");
      return null;
    }
  }

  // --- LOGICA LOGIN ---
  async function validarUsuario() {
    const socio = document.getElementById('login-socio').value;
    const fecha = document.getElementById('login-fecha').value;
    
    if(!socio || !fecha) return alert("Complete todos los campos");
    
    const fechaRegex = /^\d{2}\/\d{2}\/\d{4}$/;
    if (!fechaRegex.test(fecha)) return alert("Formato de fecha inválido. Use DD/MM/AAAA (ej: 01/05/1990)");

    const response = await llamarAPI('validarSocio', { socio: socio, fecha: fecha });
    
    if (response && response.success) {
        usuarioActual = { id: socio, nombre: response.nombre };
        document.getElementById('view-login').classList.add('hidden');
        document.getElementById('view-booking').classList.remove('hidden');
        document.getElementById('welcome-msg').innerText = "Hola, " + response.nombre;
        inicializarFormulario();
    } else {
        alert("Socio no encontrado o fecha incorrecta.");
    }
  }

  // --- LOGICA RESERVA ---
  function inicializarFormulario() {
    const selectHora = document.getElementById('reserva-hora');
    selectHora.innerHTML = "";
    // Horario 7 a 21 (el ultimo turno inicia a las 20 para terminar a las 21 si es 1h)
    for(let i=7; i<=20; i++) { 
       let opt = document.createElement('option');
       opt.value = i;
       opt.text = i + ":00 hs";
       selectHora.appendChild(opt);
    }
    generarCamposJugadores();
  }

  function cargarConfiguracionDia() {
    const fechaInput = document.getElementById('reserva-fecha').value;
    if(!fechaInput) return;
    
    const fechaDate = new Date(fechaInput + 'T00:00:00');
    const diaSemana = fechaDate.getDay(); // 0=Dom, 1=Lun, etc.
    
    if(diaSemana === 1) { // Lunes
      alert("El club permanece cerrado los lunes.");
      document.getElementById('reserva-fecha').value = "";
      document.getElementById('config-area').classList.add('hidden');
      return;
    }
    
    document.getElementById('config-area').classList.remove('hidden');
    cargarCanchas(); 
  }

  async function cargarCanchas() {
    const fechaInput = document.getElementById('reserva-fecha').value;
    if(!fechaInput) return;
    
    const fechaDate = new Date(fechaInput + 'T00:00:00');
    const diaSemana = fechaDate.getDay();
    
    // Regla: Martes(2) a Viernes(5) = 2 canchas. Sab(6) y Dom(0) = 6 canchas.
    let numCanchas = (diaSemana === 0 || diaSemana === 6) ? 6 : 2;

    const horaSeleccionada = parseInt(document.getElementById('reserva-hora').value);
    const duracion = parseInt(document.getElementById('reserva-duracion').value);
    
    // Obtener reservas ocupadas desde el backend
    const ocupadas = await llamarAPI('obtenerDisponibilidad', { fechaStr: fechaInput });
    
    const selectCancha = document.getElementById('reserva-cancha');
    selectCancha.innerHTML = "";
    document.getElementById('msg-disponibilidad').innerText = "";

    if(ocupadas) {
       let contadorDisponibles = 0;
       for(let c=1; c<=numCanchas; c++) {
         let disponible = true;
         
         // Verificar conflicto
         for(let r of ocupadas) {
           if(parseInt(r.cancha) === c) {
             let rInicio = parseInt(r.hora);
             let rFin = rInicio + parseInt(r.duracion);
             let uInicio = horaSeleccionada;
             let uFin = horaSeleccionada + duracion;
             
             // Si hay solapamiento de rangos
             if (Math.max(rInicio, uInicio) < Math.min(rFin, uFin)) {
               disponible = false;
             }
           }
         }
         
         if(disponible) {
           let opt = document.createElement('option');
           opt.value = c;
           opt.text = "Cancha " + c;
           selectCancha.appendChild(opt);
           contadorDisponibles++;
         }
       }
       
       if(contadorDisponibles === 0) {
         let opt = document.createElement('option');
         opt.text = "Sin disponibilidad";
         selectCancha.appendChild(opt);
